#!/bin/bash
set -e

fatal() {
    printf >&2 "%s\n" "$*"
    exit 1
}

BRANCH=$(git rev-parse --abbrev-ref HEAD)
REMOTE=$(git config branch."$BRANCH".remote || fatal "no remote branch")
MERGE=$(git config branch."$BRANCH".merge || fatal "no merge branch")

if [[ "$MERGE" != refs/heads/* ]]; then
    git fetch -p "$REMOTE" "$MERGE"
    git merge --ff-only FETCH_HEAD
else
    MERGE=${MERGE#refs/heads/}
    git fetch -p "$REMOTE"
    git merge --ff-only "$REMOTE"/"$MERGE"
fi

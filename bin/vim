#!/bin/bash

# http://en.wikipedia.org/wiki/ANSI_escape_code
ESC=$'\033'
OSC="$ESC]"
ST="$ESC\\"

# http://invisible-island.net/xterm/ctlseqs/ctlseqs.txt
set_color() {
    local Ps=4 c=$1 spec=$2
    echo -n "$OSC$Ps;$c;$spec$ST" >/dev/tty
}

query_color() {
    local c=$1
    set_color "$c" "?"

    # xterm: \033]4;$c;rgb:RRRR/GGGG/BBBB\033\\
    # urxvt: \033]4;rgb:RRRR/GGGG/BBBB\033
    # konsole: nothing
    local ret=1 esc data slash result
    if read -r -N 1 -t 0.01 esc; then
        if [[ "$esc" == $'\033' ]]; then
            IFS= read -r -d $'\033' -t 1 data
            read -r -N 1 -t 0.01 slash
            result=$(echo "$data" | sed -e "s/^]4;\($c;\)\?//")
            ret=0
            eval "color$c=\"$result\""
        fi
    fi

    return $ret
}

set_background() {
    local Ps=11 Pt=$1
    echo -n "$OSC$Ps;$Pt$ST" >/dev/tty
}

query_background() {
    set_background "?"

    # xterm: \033]11;rgb:RRRR/GGGG/BBBB\033\\
    # urxvt: \033]11;rgb:RRRR/GGGG/BBBB\033
    # konsole: nothing
    local ret=1 esc data slash result
    if read -r -N 1 -t 0.01 esc; then
        if [[ "$esc" == $'\033' ]]; then
            IFS= read -r -d $'\033' -t 1 data
            read -r -N 1 -t 0.01 slash
            result=$(echo "$data" | sed -e "s/^]11;//")
            ret=0
            eval "background=\"$result\""
        fi
    fi

    return $ret
}

query_colors() {
    local i
    for i in {0..15}; do
        query_color $i || return 1
    done
    query_background || return 1
    return 0
}

query_tty() {
    local ret=0

    exec </dev/tty
    oldstty=$(stty -g)
    stty raw -echo min 0

    query_colors || ret=$?

    stty $oldstty

    return $ret
}

if query_tty; then
    set_color  0 "rgb:07/36/42"
    set_color  1 "rgb:dc/32/2f"
    set_color  2 "rgb:85/99/00"
    set_color  3 "rgb:b5/89/00"
    set_color  4 "rgb:26/8b/d2"
    set_color  5 "rgb:d3/36/82"
    set_color  6 "rgb:2a/a1/98"
    set_color  7 "rgb:ee/e8/d5"
    set_color  8 "rgb:00/2b/36"
    set_color  9 "rgb:cb/4b/16"
    set_color 10 "rgb:58/6e/75"
    set_color 11 "rgb:65/7b/83"
    set_color 12 "rgb:83/94/96"
    set_color 13 "rgb:6c/71/c4"
    set_color 14 "rgb:93/a1/a1"
    set_color 15 "rgb:fd/f6/e3"
    #set_background "rgb:00/2b/36" # dark
    set_background "rgb:fd/f6/e3" # light
    /usr/bin/vim "$@"
    ret=$?
    for i in {0..15}; do
        eval "set_color \$i \"\$color$i\""
    done
    set_background "$background"
    exit $ret
else
    exec /usr/bin/vim "$@"
fi
